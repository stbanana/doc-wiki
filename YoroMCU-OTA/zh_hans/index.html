<!DOCTYPE html>

<html lang="zh-CN"  class=" md_page ">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="">
    
    
    <meta name="description" content="">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <meta name="html-generator" content="teedoc-plugin-jupyter-notebook-parser">
        
        <script src="/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/static/css/search/style.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/custom.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/gitalk/gitalk.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/gitalk/custom_gitalk.css" type="text/css"/>
        
    
    
    <title>土星环的图书馆</title>
    
    <script type="text/javascript">js_vars = {}</script>
    <script type="text/javascript">metadata = {"tags": [], "date": "2025-08-14", "update": [{"date": "2025-08-14", "author": "yono", "version": "0.1.0", "content": "定义基础消息结构"}], "ts": 1755129600, "author": "", "brief": "", "cover": "", "update_open": true}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/">
                
                    <img class="site_logo" src="/static/logo/yono_wiki.svg" alt="yono loge">
                
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
<li class="sub_items "><a >API文档</a><ul><li class=""><a  href="/modbusX/zh_hans/">modbusX</a></li>
<li class=""><a  href="/Dataflow/zh_hans/">Dataflow</a></li>
</ul>
</li>
<li class="sub_items active_parent"><a >协议文档</a><ul><li class=""><a  href="/HiLBase/zh_hans/">HiLBase</a></li>
<li class="active"><a  href="/YoroMCU-OTA/zh_hans/">YoroMCU-OTA</a></li>
</ul>
</li>
</ul>

            </div>
            <div>
                <ul id="nav_right">
<li class=""><a  href="https://www.yono233.cn">博客</a></li>
</ul>

                <ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">搜索</span>
                            <div id="search_hints">
                                <span id="search_input_hint">输入关键词，多关键词空格隔开</span>
                                <span id="search_loading_hint">正在加载，请稍候。。。</span>
                                <span id="search_download_err_hint">下载文件失败，请刷新重试或检查网络</span>
                                <span id="search_other_docs_result_hint">来自其它文档的结果</span>
                                <span id="search_curr_doc_result_hint">当前文档搜索结果</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active no_link sidebar_category"><span class="label">YoroMCU-OTA</span></li>
<li class="active with_link"><a href="/YoroMCU-OTA/zh_hans/index.html"><span class="label">基础消息结构</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/YoroMCU-OTA/zh_hans/doc/UART单对单包装.html"><span class="label">UART单对单包装</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/YoroMCU-OTA/zh_hans/doc/CAN包装.html"><span class="label">CAN包装</span><span class=""></span></a></li>
<li class="not_active  with_link"><a href="https://github.com/stbanana/YoroMCU-OTA" ><span class="label">项目源码</span><span class=""></span></a></li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1></h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                                <span class="article_date" title="最后修改日期： 2025-08-14">
                                    2025-08-14
                                </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                        
                        <details open>
                        
                            <summary>更新历史</summary>
                            <div>
                                <table>
                                        <thead>
                                            <tr>
                                                <th>日期</th>
                                                <th>版本</th>
                                                <th>作者</th>
                                                <th>更新内容</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            
                                                <tr>
                                                    <td>2025-08-14</td>
                                                    <td>0.1.0</td>
                                                    <td>yono</td>
                                                    <td>
                                                    
                                                        定义基础消息结构
                                                    
                                                    </td>
                                                </tr>
                                            
                                        </tbody>
                                </table>
                            </div>
                        </details>
                        
                    </div>
                    <div id="article_content">
                        
                            <h1 id="%E6%A6%82%E8%BF%B0">概述</h1>
<p>这是一个简单的 MCU-OTA 基础协议，采用短帧形式发送和接收，适合极小资源的实现，同时对不同的物理链路保证了基本的纠错，并便于更复杂纠错的拓展开发。</p>
<h1 id="%E5%9F%BA%E7%A1%80%E6%B6%88%E6%81%AF%E7%BB%93%E6%9E%84">基础消息结构</h1>
<p>对于不同的物理接口，例如 UART、CAN、LAN ，各有自己不同的校验机制。但基础的有价值消息是统一的，在此定义基础的消息结构。因为其他的接口消息是完全流式可定义的，无需兼容，所以<strong>此消息结构更多的是对 CAN 消息的兼容</strong>。</p>
<p>通常采用烧录上位机与被烧录设备<strong>一发一收</strong>的形式，在广播多机烧录中采用<strong>一发多收</strong>(此部分库不方便全兼容，需要定制)。</p>
<blockquote>
<p>[!NOTE]</p>
<p>整个文档中涉及的数字均为 16 进制，可能不添加 0x 或 h 提示。</p>
</blockquote>
<h2 id="%E8%AF%B7%E6%B1%82%E5%8D%95%E5%B8%A7%E7%BB%93%E6%9E%84">请求单帧结构</h2>
<table>
<thead>
<tr>
  <th>控制消息(4字节)</th>
  <th>额外消息(n字节)</th>
</tr>
</thead>
<tbody>
<tr>
  <td></td>
  <td></td>
</tr>
</tbody>
</table>
<p>请求通常由烧录机，例如上位机软件发出。</p>
<p>其中<strong>控制消息</strong>表达了：</p>
<ul>
<li>向谁发送</li>
<li>做什么</li>
<li>由谁发送</li>
</ul>

<pre class="language-c"><code class="language-c">/* 具体位含义 */
typedef struct
{
    uint16_t bParaID:6; //BIT0-BIT5,模块ID(0-63)
    uint16_t bCabID :4; //BIT6-BIT9,机柜ID(0-15)
    uint16_t bRX_Mes:6; //BIT10-BIT15,收件方信息
    uint16_t bKind  :8; //BIT16-BIT23,Command/Event的Kind
    uint16_t bTX_Mes:3; //BIT24-BIT26,寄件人信息
    uint16_t bBITs  :5; //BIT27-BIT31通常无实际意义 在CAN总线中可用于优先级仲裁
} BOOT_PARSE_MSG_BIT;
</code></pre>
<p><strong>额外消息</strong>则表达了一些拓展信息，例如在指示烧录flash地址时包含地址信息，在烧录过程中传输固件。</p>
<p>一个经典的握手发送帧示例</p>

<pre class="language-c"><code class="language-c">/* 控制信息 */
05 // 高8位，指示寄件人是0x05意味着烧录上位机，后续会介绍寄件人定义
FA // kind指示，表示对模块类型1进行烧录，后续会介绍更多定义
04 01 // 收件人是0x01意味着模块类型1，机柜ID是0代表机柜广播，模块ID是1代表对模块1烧录

/* 额外消息，无实际意义，握手时控制信息已经可以表达所有有效信息 */
00
01
00
00
00
00
00
00
</code></pre>
<h2 id="%E5%9B%9E%E5%A4%8D%E5%8D%95%E5%B8%A7%E7%BB%93%E6%9E%84">回复单帧结构</h2>
<p>对于任意请求都需要回复，指示对请求的处理情况</p>
<table>
<thead>
<tr>
  <th>控制消息(4字节)</th>
  <th>回复状态(8字节)</th>
</tr>
</thead>
<tbody>
<tr>
  <td></td>
  <td></td>
</tr>
</tbody>
</table>
<p><strong>控制消息</strong>与请求的结构和定义是统一的。</p>
<p><strong>回复状态</strong>的第一第二字节应该复制请求部分，用于辅助校验，<strong>第四字节是实际的状态指示</strong>。</p>
<p>对上面握手消息的回复为</p>

<pre class="language-c"><code class="language-c">/* 控制信息 */
00 // 高8位，指示寄件人是0x00意味着模块类型1
FA // 与握手相同kind
80 41 // 收件人是0x20意味着上位机，机柜ID是自己0x01一号机柜，模块ID是1代表自己模块号1

/* 回复状态 */
00
01 // 头两个字节复制了消息
00
06 // 这是实际状态位 0x06表示ACK默认的成功
00 // 其他字节都属于预留部分
00
00
00
</code></pre>
<h1 id="%E6%8E%A7%E5%88%B6%E6%B6%88%E6%81%AF%E5%90%84%E4%BD%8D%E5%9F%9F%E8%AF%A6%E8%A7%A3">控制消息各位域详解</h1>
<h2 id="bParaID%3A6">bParaID:6</h2>
<p>BIT0-BIT5,模块ID(0-63)</p>
<p>在一个机柜中可能存在多个板卡模块，或者机器模块，那么在总线上他们应该有唯一ID，这就是在机柜层的唯一ID。指示了应该由谁解析请求，也指示了是谁回复的。</p>
<h2 id="bCabID-%3A4">bCabID :4</h2>
<p>BIT6-BIT9,机柜ID(0-15)</p>
<p>同上，在一个大的总线上可能具有多个机柜，那么总线上应该有唯一ID，这个部分进行了指示。</p>
<h2 id="bRX_Mes%3A6">bRX_Mes:6</h2>
<p>BIT10-BIT15,收件方信息</p>
<p>可能的值有以下这些，通常库中会做枚举或宏定义</p>

<pre class="language-c"><code class="language-c">0x01 // 被烧录模块类型1
0x02 // 被烧录模块类型2
0x04 // 被烧录模块类型3
0x08 // 被烧录模块类型4
0x10 // 被烧录模块类型5
0x20 // 烧录上位机
</code></pre>
<p>这个存在的意义是：假设某个机器，其中有一片 stm32、一片 GD32，由于他们在同一台机器中，对外认为是同一机器 ID；但两个芯片负责不同的功能，具有不同的程序固件。那么我们可以<strong>对 stm32 定义为模块类型1，对 GD32 定义为模块类型2，以此在 OTA 时进行有区分的升级。</strong></p>
<h2 id="bKind%3A8">bKind:8</h2>
<p>BIT16-BIT23,Command/Event的Kind</p>
<p>可能的值有以下这些</p>

<pre class="language-c"><code class="language-c">0xFA // 命令烧录模块类型1 同时兼容ping功能
0xFB // 命令烧录模块类型2 同时兼容ping功能
0xFC // 命令烧录模块类型3 同时兼容ping功能
0xFD // 命令烧录模块类型4 同时兼容ping功能
0xFF // 命令烧录模块类型5 同时兼容ping功能

0xF3 // 统计烧录台数
0xF4 // 擦除数据命令
0xF5 // 烧录数据
0xF6 // 应答烧录台数
0xF7 // 烧录指示信息，包含地址、长度、校验
0xF8 // 结束重启，跳转APP
</code></pre>
<p>一个最简的烧录流程</p>
<ol>
<li><strong>0xFA 命令烧录</strong>，此时需要从APP跳入OTA程序</li>
<li><strong>0xFA 再次命令烧录</strong>，作为ping功能，区别在于<strong>回复状态</strong>的头两个字节，跳转回复是00 01，而ping是00 02，表达已经在OTA程序中</li>
<li><strong>0xF4 擦除指示</strong>，将固件需要的部分ROM全部擦掉</li>
<li><strong>0xF7 首包指示</strong></li>
<li><strong>许多 0xF5 包</strong>，符合指示的长度，但是 OTA 会寄存最开始数个字节而不烧录，使得 APP 不完整。</li>
<li><strong>反复进行 4、5 直到上位机认为完成</strong></li>
<li><strong>此时 OTA 程序自校验</strong>是否长度、校验都符合，写入最开始的数个字节，使得 APP 完整。</li>
<li><strong>0xF8 上位机发起重启跳转</strong>，接收到确认回复，完成烧录</li>
</ol>
<p>烧录请求帧的回复都是完全统一的，可见前面的帧结构，以下对流程中不同的kind需要携带怎样的额外信息作说明。</p>
<blockquote>
<p><strong>0xFA~0xFF</strong> ：ping/跳转包，额外消息无所谓，只要有两个字节供回复校验即可</p>
<p><strong>0xF3</strong>：统计包，额外消息无所谓，只要有两个字节供回复校验即可</p>
<p><strong>0xF4</strong>：擦除包，额外消息8字节，前4个字节从低到高指示了擦除起始地址，后四个字节从低到高指示了总长度。例如起始地址为0x11223344，擦除总长0x55667788，那么额外消息为 44 33 22 11 88 77 66 55</p>
<p><strong>0xF5</strong>：烧录数据包，此前已经进行过指示，这里额外消息将固件十六进制发送即可。在CAN中共8字节，而其他通信则视实际情况加长，在达到指示长度前，被烧录设备不会回复</p>
<p><strong>0xF6</strong>：与统计包配合的回复，避免多次统计所以kind错开</p>
<p><strong>0xF7</strong>：接下来固件的烧录提示，额外消息8字节，前4个字节从低到高指示了起始地址，随后2个字节从第到高指示了连续包的和校验，最后2个字节从低到高指示了连续固件的长度。例如连续烧录从0x11224455开始，这些固件十六进制的和校验为0x3456，总长度0x200，那么额外信息为 55 44 22 11 56 34 00 02</p>
<p><strong>0xF8</strong>：完成的跳转/重启包，额外消息无所谓，只要有两个字节供回复校验即可</p>
</blockquote>
<h2 id="bTX_Mes%3A3">bTX_Mes:3</h2>
<p>BIT24-BIT26,寄件人信息</p>
<p>可能的值有以下这些，通常库中会做枚举或宏定义</p>

<pre class="language-c"><code class="language-c">0x00 // 被烧录模块类型1
0x01 // 被烧录模块类型2
0x02 // 被烧录模块类型3
0x03 // 被烧录模块类型4
0x04 // 被烧录模块类型5
0x05 // 烧录上位机
</code></pre>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                    </div>
                    <div id="next">
                        
                        <a href="/YoroMCU-OTA/zh_hans/doc/UART单对单包装.html">
                            <span class="label">UART单对单包装</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>链接</a><ul><li><a target="_blank" href="https://teedoc.neucrack.com">使用 teedoc 构建</a></li>
<li><a  href="/sitemap.xml">网站地图</a></li>
</ul>
</li>
<li><a>源码</a><ul><li><a target="_blank" href="https://github.com/stbanana">github</a></li>
<li><a target="_blank" href="https://github.com/stbanana/doc-wiki">本网站源文件</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
<li><a target="_blank" href="https://beian.miit.gov.cn"></a></li>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script src="/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/static/js/theme_default/main.js"></script>
    
        <script src="/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/static/css/theme_default/prism.min.js"></script>
    
        <script src="/static/js/search/search_main.js"></script>
    
        <script src="/static/js/custom.js"></script>
    
        <script src="/static/js/gitalk/gitalk.min.js"></script>
    
        <script src="/static/js/gitalk/main.js"></script>
    
</body>

</html>